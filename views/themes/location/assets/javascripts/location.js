"use strict";function qorInitMapAssets(o){$(o).each(function(){var o=$(this),t=o.data(),e=t.locationMapsource,i=t[e+"Apikey"],a="qor_map_"+e,n=void 0;if("baidu"===e){if($("#"+a).length)return void new QorLocation($(this)).initBaiduMap();n="//api.map.baidu.com/api?v=2.0&ak="+i+"&callback=qorInitBaiduMap"}else if("google"===e){if($("#"+a).length)return void new QorLocation($(this)).initGoogleMap();n="//maps.googleapis.com/maps/api/js?key="+i+"&callback=qorInitGoogleMap"}else console.log("QOR only support baidu or google Map, please make sure your Map config is correct!");qorLoadMapScript(n,a)})}function qorInitBaiduMap(){$('[data-toggle="qor.location"]').each(function(){new QorLocation($(this)).initBaiduMap()})}function qorInitGoogleMap(){$('[data-toggle="qor.location"]').each(function(){new QorLocation($(this)).initGoogleMap()})}function qorLoadMapScript(o,t){var e=document.createElement("script");e.src=o,e.id=t,document.body.appendChild(e)}function QorLocation(o,t){this.$element=$(o),this.options=$.extend({},QorLocation.DEFAULTS,$.isPlainObject(t)&&t),this.roles={},this.init()}QorLocation.prototype={constructor:QorLocation,init:function(){var o=this.$element,t=o.find("[data-location-role]"),e=this.roles,i=void 0;this.MAP_ID=o.find(".qor__location-map")[0],this.isGoogle="google"===o.data("location-mapsource"),this.$location=o.find(".qor__location-address"),t.each(function(){i=$(this).data("location-role"),e["$"+i]=$(this)}),this.bind()},bind:function(){this.roles.$reverseGeocode.on("click",this.getAddress.bind(this)),this.roles.$geocode.on("click",this.getPosition.bind(this))},initGoogleMap:function(){var o={enableHighAccuracy:!0,timeout:5e3,maximumAge:0},t=this.roles,e=Number(t.$latitude.val()),i=Number(t.$longitude.val()),a=this;0===e&&0===i?navigator.geolocation.getCurrentPosition(function(o){a.setupGoogleMap({lat:o.coords.latitude,lng:o.coords.longitude})},function(o){console.warn("ERROR("+o.code+"): "+o.message)},o):this.setupGoogleMap({lat:e,lng:i})},setupGoogleMap:function(o){this.map=new google.maps.Map(this.MAP_ID,{center:o,zoom:16}),this.marker=new google.maps.Marker({position:o,draggable:!0,map:this.map}),this.mapGeo=new google.maps.Geocoder,google.maps.event.bind(this.marker,"dragend",this,this.moveMarker),this.moveMarker()},initBaiduMap:function(){var o=this.roles,t=Number(o.$latitude.val()),e=Number(o.$longitude.val()),i=new BMap.Point(e,t),a=this;if(0===t&&0===e){(new BMap.Geolocation).getCurrentPosition(function(o){this.getStatus()==BMAP_STATUS_SUCCESS?a.setupBaiduMap(o.point):console.log("failed"+this.getStatus())},{enableHighAccuracy:!0})}else this.setupBaiduMap(i)},setupBaiduMap:function(o){var t=new BMap.Map(this.MAP_ID),e=new BMap.Marker(o);t.centerAndZoom(o,18),t.enableScrollWheelZoom(),t.addOverlay(e),t.panTo(o),e.enableDragging(),e.addEventListener("dragend",this.moveMarker.bind(this)),this.marker=e,this.map=t,this.mapGeo=new BMap.Geocoder,this.moveMarker()},moveMarker:function(){var o=this.$location,t=this.mapGeo,e=this.marker.getPosition();this.isGoogle?t.geocode({latLng:e},function(t,e){e==google.maps.GeocoderStatus.OK&&o.html(t[0].formatted_address)}):t.getLocation(e,function(t){t&&o.html(t.address)})},getPosition:function(){var o=this.map,t=this.roles,e=this.marker,i=this.$location,a=t.$city.val(),n=t.$address.val(),s=this.mapGeo;if(this.isGoogle)s.geocode({address:n+", "+a},function(a,n){if(n===google.maps.GeocoderStatus.OK){var s=a[0],r=s.geometry.location;o.setCenter(r),e.setPosition(r),t.$latitude.val(r.lat),t.$longitude.val(r.lng),i.html(s.formatted_address)}else QOR.qorConfirm("Geocode was not successful for the following reason: "+n)});else{if(""==a||""==n)return void QOR.qorConfirm("Please ensure that the city and address have been filled in correctly!");s.getPoint(n,function(i){i&&(t.$latitude.val(i.lat),t.$longitude.val(i.lng),o.centerAndZoom(i,18),e.setPosition(i))},a)}},getAddress:function(){var o=this.marker.getPosition(),t=this.mapGeo,e=this.roles,i=this;e.$latitude.val(o.lat),e.$longitude.val(o.lng),this.isGoogle?t.geocode({location:o},function(o,t){t==google.maps.GeocoderStatus.OK&&i.setLocationFromGoogle(o[0])}):t.getLocation(new BMap.Point(o.lng,o.lat),function(o){o&&(e.$address.val(o.address),e.$city.val(o.addressComponents.city),e.$region.val(o.addressComponents.district))})},setLocationFromGoogle:function(o){var t=this.roles,e="",i="",a="",n="",s="",r={street_number:"",route:"",postal_code:"",administrative_area_level_1:"",locality:"",country:""},l=void 0,c=void 0,d=o.address_components;for(var u in d){var g=d[u].types;for(var p in g)"country"==g[p]&&(e=d[u].long_name),r[g[p]]=d[u].short_name}a=r.locality||r.sublocality||r.administrative_area_level_3,n="FR"==r.country?r.administrative_area_level_1:r.administrative_area_level_2||r.administrative_area_level_1,s=r.postal_code,l=o.formatted_address.split(a),c=l[0],s&&""!=s&&(c=c.replace(s,"")),i=c.replace(n,"")==c?c:l[1],i=i.replace(/[\,\s]+$/i,""),o.formatted_address.match(/^\d*,/)&&(i=""),t.$country.val(e),t.$zip.val(s),t.$region.val(n),t.$city.val(a),t.$address.val(i)}},$(function(){var o='[data-toggle="qor.location"]';qorInitMapAssets(o),$(document).on("enable.qor.location",function(){qorInitMapAssets(o)})});